# 2026-02-25 작업 로그 (보안 마스킹 버전)

## 1) 운영 장애 원인 추적 (CORS/500)
- 증상:
  - `https://www.mungai.co.kr`에서 `auth/me`, `dashboard` 호출 시 CORS 에러처럼 보이는 실패 발생.
  - 브라우저 콘솔: `No Access-Control-Allow-Origin` + `500 Internal Server Error`.
- 판단:
  - CORS 1차 원인 아님.
  - 서버 내부 500 발생 후 응답 경로에서 CORS 헤더가 누락되어 2차적으로 CORS 에러처럼 노출.

## 2) 백엔드 진단 강화 및 코드 정리
- 반영 파일:
  - `Backend/app/main.py`
    - 요청별 `request_id` 추적 강화.
    - `X-Request-ID` 응답 헤더 주입.
    - 미들웨어/전역 예외 로깅 강화.
  - `Backend/app/features/dashboard/router.py`
    - `dog_id` 타입 처리 정리(UUID 기준).
  - `Backend/app/features/dashboard/service.py`
    - `dog_env` JSON 필드 방어 파싱(legacy/비정형 데이터 대응).
- 검증:
  - `python -m py_compile` 기준 문법 오류 없음.

## 3) Supabase MCP 및 스키마 점검
- MCP 연결:
  - 프로젝트 조회/SQL 실행/테이블 조회 정상.
- 점검 항목 확인:
  - `dogs.anonymous_sid`, `dogs.created_at` 존재 확인.
  - `users.provider`, `users.kakao_sync_id` 존재 확인.
- 결론:
  - 운영 장애의 직접 원인은 스키마 누락이 아님.

## 4) 최종 원인 확정 및 복구
- Fly 로그 핵심 에러:
  - `sqlalchemy.exc.ArgumentError: Could not parse SQLAlchemy URL from given URL string`
- 원인:
  - `DATABASE_URL` 문자열/호스트 설정 불일치.
  - Supabase Transaction Pooler 엔드포인트가 실제 값과 달랐음.
- 조치:
  - 비밀번호 URL 인코딩 적용.
  - `DATABASE_URL`을 Supabase 제공 pooler 주소(`aws-1-ap-northeast-2.pooler.supabase.com:6543`) 기준으로 재설정.
  - Fly rolling update 완료.

## 5) 복구 후 상태 확인
- `GET /health` -> `200` 정상.
- `GET /api/v1/auth/me` (무토큰) -> `401` 정상 + CORS 헤더 정상.
- `GET /api/v1/dashboard/` (guest cookie) -> `200` 정상 + CORS 헤더 정상.
- 결론:
  - 운영 장애 해소.

## 6) 보안 원칙
- 본 문서에는 비밀번호/토큰/키 원문을 기록하지 않음.
- 민감값은 Fly Secrets로만 관리.

## 후속 권장 작업
- Supabase DB 비밀번호 변경 시 체크리스트 문서화:
  1. 비밀번호 URL 인코딩
  2. `DATABASE_URL` 갱신
  3. 배포/롤링 업데이트
  4. `/health`, `/auth/me`, `/dashboard` 스모크 테스트
- 아카이브 문서에서 민감값 노출 여부 주기 점검.
